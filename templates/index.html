<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„¸ì¼ì¦ˆë§µ CRM - ë§¤í•‘ í‚¤ ê²€ì‚¬ê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .controls {
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls label {
            font-weight: 600;
            color: #333;
        }

        .controls input[type="number"] {
            width: 80px;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .controls button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .controls button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .group-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .group-box:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .group-box input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 600;
        }

        .group-box textarea {
            width: 100%;
            height: 200px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            line-height: 1.6;
        }

        .group-box textarea:focus,
        .group-box input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .item-count {
            font-size: 13px;
            color: #666;
            margin-top: 8px;
            font-weight: 500;
        }

        .analyze-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 30px;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .analyze-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            display: none;
        }

        .results.show {
            display: block;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .summary-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .summary-card .number {
            font-size: 32px;
            font-weight: 700;
        }

        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            font-size: 1.5em;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .matrix-table th,
        .matrix-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .matrix-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .matrix-table tr:hover {
            background: #f0f0f0;
        }

        .percentage {
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }

        .percentage.high {
            background: #d4edda;
            color: #155724;
        }

        .percentage.medium {
            background: #fff3cd;
            color: #856404;
        }

        .percentage.low {
            background: #f8d7da;
            color: #721c24;
        }

        .items-list {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .items-list ul {
            list-style: none;
        }

        .items-list li {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .items-list li:last-child {
            border-bottom: none;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge.success {
            background: #d4edda;
            color: #155724;
        }

        .badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge.danger {
            background: #f8d7da;
            color: #721c24;
        }

        .collapsible {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .collapsible:hover {
            background: #f0f0f0;
        }

        .collapsible::after {
            content: 'â–¼';
            transition: transform 0.3s;
        }

        .collapsible.active::after {
            transform: rotate(-180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .loading .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error.show {
            display: block;
        }

        @media (max-width: 768px) {
            .groups-container {
                grid-template-columns: 1fr;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.5em;
        }

        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        .edit-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .edit-item-header {
            font-weight: 700;
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .edit-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .edit-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .edit-option:hover {
            border-color: #667eea;
            background: #f3f4ff;
        }

        .edit-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .edit-option label {
            flex: 1;
            cursor: pointer;
            font-size: 14px;
        }

        .edit-option .similarity-badge {
            background: #28a745;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .custom-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 5px;
        }

        .custom-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-footer .progress {
            color: #666;
            font-size: 14px;
        }

        .modal-footer .actions {
            display: flex;
            gap: 10px;
        }

        .btn-apply {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-apply:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-skip {
            padding: 12px 30px;
            background: #e0e0e0;
            color: #666;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-skip:hover {
            background: #d0d0d0;
        }

        .edit-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .edit-btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .download-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            border: 2px solid #667eea;
        }

        .download-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” ì„¸ì¼ì¦ˆë§µ CRM ë§¤í•‘ í‚¤ ê²€ì‚¬ê¸°</h1>
            <p>ê³ ê°, íšŒì‚¬, ë¦¬ë“œ, ë”œ, ì»¤ìŠ¤í…€ ì˜¤ë¸Œì íŠ¸ ê°„ ë°ì´í„° ë§¤í•‘ ì¼ì¹˜ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <div class="content">
            <div class="controls">
                <label for="numGroups">ë¹„êµí•  ê·¸ë£¹ ìˆ˜:</label>
                <input type="number" id="numGroups" min="2" max="10" value="2">
                <button onclick="generateGroups()">ê·¸ë£¹ ìƒì„±</button>
            </div>

            <div class="groups-container" id="groupsContainer">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>

            <button class="analyze-btn" onclick="analyzeData()">ğŸ” ë¶„ì„ ì‹œì‘</button>

            <div class="error" id="error"></div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>

            <div class="results" id="results">
                <!-- ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë¨ -->
            </div>

            <!-- ë‹¤ìš´ë¡œë“œ ì„¹ì…˜ -->
            <div class="download-section" id="downloadSection" style="display: none;">
                <h3 style="margin-bottom: 15px;">ğŸ“¥ êµì •ëœ ë°ì´í„° ë‹¤ìš´ë¡œë“œ</h3>
                <p style="color: #666; margin-bottom: 15px;">ëª¨ë“  ìˆ˜ì •ì‚¬í•­ì´ ë°˜ì˜ëœ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”</p>
                <button class="download-btn" onclick="downloadCorrectedData()">ë‹¤ìš´ë¡œë“œ (TSV í˜•ì‹)</button>
            </div>
        </div>
    </div>

    <!-- í†µí•© í¸ì§‘ ëª¨ë‹¬ -->
    <div class="modal" id="unifiedEditModal">
        <div class="modal-content" style="max-width: 1100px;">
            <div class="modal-header">
                <h2>ğŸ”— ìœ ì‚¬ í•­ëª© í†µí•© í¸ì§‘</h2>
                <button class="modal-close" onclick="closeUnifiedModal()">&times;</button>
            </div>
            <div class="modal-body" id="unifiedModalBody" style="max-height: 70vh; overflow-y: auto;">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
            <div class="modal-footer">
                <div class="progress" id="unifiedModalProgress">0ê°œ ê·¸ë£¹</div>
                <div class="actions">
                    <button class="btn-skip" onclick="closeUnifiedModal()">ì·¨ì†Œ</button>
                    <button class="btn-apply" onclick="applyUnifiedChanges()">ëª¨ë“  ì‹œíŠ¸ì— ë°˜ì˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;

        // ì´ˆê¸° ê·¸ë£¹ ìƒì„±
        window.onload = function() {
            generateGroups();
        };

        function generateGroups() {
            const numGroups = parseInt(document.getElementById('numGroups').value);
            const container = document.getElementById('groupsContainer');
            container.innerHTML = '';

            for (let i = 0; i < numGroups; i++) {
                const groupBox = document.createElement('div');
                groupBox.className = 'group-box';
                groupBox.innerHTML = `
                    <input type="text"
                           id="groupName${i}"
                           value="ê·¸ë£¹ ${i+1}"
                           placeholder="ê·¸ë£¹ ì´ë¦„">
                    <textarea id="groupData${i}"
                              placeholder="ì—¬ê¸°ì— ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”&#10;(ì—‘ì…€/êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë³µì‚¬í•œ ë°ì´í„°)"
                              oninput="updateCount(${i})"></textarea>
                    <div class="item-count" id="count${i}">0ê°œ í•­ëª©</div>
                `;
                container.appendChild(groupBox);
            }

            document.getElementById('results').classList.remove('show');
        }

        function updateCount(index) {
            const textarea = document.getElementById(`groupData${index}`);
            const text = textarea.value.trim();
            const lines = text ? text.split('\n').filter(line => line.trim()).length : 0;
            document.getElementById(`count${index}`).textContent = `${lines}ê°œ í•­ëª©`;
        }

        async function analyzeData() {
            const numGroups = parseInt(document.getElementById('numGroups').value);
            const data = { num_groups: numGroups };

            // ê° ê·¸ë£¹ì˜ ë°ì´í„° ìˆ˜ì§‘
            for (let i = 0; i < numGroups; i++) {
                data[`group_${i}_name`] = document.getElementById(`groupName${i}`).value;
                data[`group_${i}_data`] = document.getElementById(`groupData${i}`).value;
            }

            // UI ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('loading').classList.add('show');
            document.getElementById('error').classList.remove('show');
            document.getElementById('results').classList.remove('show');

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }

                currentData = result;
                displayResults(result);

            } catch (error) {
                document.getElementById('error').textContent = error.message;
                document.getElementById('error').classList.add('show');
            } finally {
                document.getElementById('loading').classList.remove('show');
            }
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            let html = '';

            // 1. ìš”ì•½ ì¹´ë“œ
            html += '<div class="summary-cards">';
            for (const [groupName, size] of Object.entries(data.group_sizes)) {
                html += `
                    <div class="summary-card">
                        <h3>${groupName}</h3>
                        <div class="number">${size}</div>
                    </div>
                `;
            }
            html += '</div>';

            // 2. ì»¤ë²„ë¦¬ì§€ ë§¤íŠ¸ë¦­ìŠ¤ (ë§¤í•‘ ì„±ê³µë¥ )
            html += '<div class="section">';
            html += '<h2>ğŸ“Š ë§¤í•‘ ì»¤ë²„ë¦¬ì§€ ë¶„ì„</h2>';
            html += '<p style="margin-bottom: 15px; color: #666;">ê° ê·¸ë£¹ì˜ í•­ëª©ì´ ë‹¤ë¥¸ ê·¸ë£¹ì— ì–¼ë§ˆë‚˜ ë§¤í•‘ë˜ëŠ”ì§€ ë³´ì—¬ì¤ë‹ˆë‹¤. ë‚®ì€ ë¹„ìœ¨ì€ ë§¤í•‘ ì‹¤íŒ¨ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.</p>';
            html += '<table class="matrix-table">';
            html += '<thead><tr><th>ì¶œë°œ ê·¸ë£¹</th><th>ëŒ€ìƒ ê·¸ë£¹</th><th>ë§¤í•‘ ì„±ê³µ</th><th>ë§¤í•‘ ì‹¤íŒ¨</th><th>ì„±ê³µë¥ </th></tr></thead>';
            html += '<tbody>';

            for (const [key, value] of Object.entries(data.coverage_matrix)) {
                const [from, to] = key.split('â†’');
                const percentage = value.percentage;
                const percentageClass = percentage >= 80 ? 'high' : percentage >= 50 ? 'medium' : 'low';

                html += `
                    <tr>
                        <td><strong>${from}</strong></td>
                        <td><strong>${to}</strong></td>
                        <td>${value.covered}ê°œ</td>
                        <td>${value.total - value.covered}ê°œ</td>
                        <td><span class="percentage ${percentageClass}">${percentage}%</span></td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            html += '</div>';

            // 3. ì°¨ì§‘í•© ë¶„ì„ (ê°„ì†Œí™” ë²„ì „)
            html += '<div class="section">';
            html += '<h2>ğŸ” ì°¨ì§‘í•© ë¶„ì„</h2>';
            html += '<p style="margin-bottom: 15px; color: #666;">ê° ê·¸ë£¹ì— ìˆì§€ë§Œ ë‹¤ë¥¸ íŠ¹ì • ê·¸ë£¹ì—ëŠ” ì—†ëŠ” í•­ëª©ë“¤ì…ë‹ˆë‹¤.</p>';

            for (const [key, value] of Object.entries(data.coverage_matrix)) {
                if (value.missing.length > 0) {
                    const [from, to] = key.split('â†’');
                    html += `
                        <div class="collapsible" onclick="toggleCollapse(this)">
                            <div>
                                <strong>${from}</strong>ì—ëŠ” ìˆì§€ë§Œ <strong>${to}</strong>ì—ëŠ” ì—†ìŒ
                                <span class="badge warning">${value.missing.length}ê°œ</span>
                            </div>
                        </div>
                        <div class="collapsible-content">
                            <div class="items-list">
                                <ul>
                    `;

                    // í•­ëª©ë§Œ ê°„ë‹¨íˆ í‘œì‹œ (ìœ ì‚¬ë„ ì œê±°)
                    for (const missingItem of value.missing) {
                        html += `<li>${missingItem.item}</li>`;
                    }

                    html += `
                                </ul>
                            </div>
                        </div>
                    `;
                }
            }

            html += '</div>';

            // í†µí•© í¸ì§‘ ë²„íŠ¼ ì¶”ê°€
            html += '<div style="text-align: center; margin-top: 30px;">';
            html += '<button class="analyze-btn" onclick="openUnifiedEditor()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">âœï¸ ìœ ì‚¬ í•­ëª© í†µí•© í¸ì§‘</button>';
            html += '</div>';

            // 4. êµì§‘í•© ë¶„ì„
            if (Object.keys(data.intersections).length > 0) {
                html += '<div class="section">';
                html += '<h2>ğŸ”— êµì§‘í•© ë¶„ì„ (ë§¤í•‘ ì„±ê³µ í•­ëª©)</h2>';
                html += '<p style="margin-bottom: 15px; color: #666;">ë‘ ê·¸ë£¹ ëª¨ë‘ì— ì¡´ì¬í•˜ëŠ” í•­ëª©ë“¤ì…ë‹ˆë‹¤. ì´ í•­ëª©ë“¤ì€ ë°ì´í„° ì´ê´€ ì‹œ ì •ìƒì ìœ¼ë¡œ ë§¤í•‘ë©ë‹ˆë‹¤.</p>';

                for (const [key, value] of Object.entries(data.intersections)) {
                    html += `
                        <div class="collapsible" onclick="toggleCollapse(this)">
                            <div>
                                <strong>${key}</strong>
                                <span class="badge success">${value.count}ê°œ</span>
                            </div>
                        </div>
                        <div class="collapsible-content">
                            <div class="items-list">
                                <ul>
                                    ${value.items.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }

                html += '</div>';
            }

            // 5. ë³µí•© ì¡°í•© ë¶„ì„ (3ê°œ ì´ìƒ ê·¸ë£¹)
            const complexCombos = Object.entries(data.combinations).filter(([key, _]) =>
                (key.match(/âˆ©/g) || []).length >= 2
            );

            if (complexCombos.length > 0) {
                html += '<div class="section">';
                html += '<h2>ğŸ”€ ë³µí•© êµì§‘í•© (3ê°œ ì´ìƒ ê·¸ë£¹)</h2>';
                html += '<p style="margin-bottom: 15px; color: #666;">3ê°œ ì´ìƒ ê·¸ë£¹ ëª¨ë‘ì— ì¡´ì¬í•˜ëŠ” í•­ëª©ë“¤ì…ë‹ˆë‹¤.</p>';

                for (const [key, value] of complexCombos) {
                    html += `
                        <div class="collapsible" onclick="toggleCollapse(this)">
                            <div>
                                <strong>${key}</strong>
                                <span class="badge success">${value.count}ê°œ</span>
                            </div>
                        </div>
                        <div class="collapsible-content">
                            <div class="items-list">
                                <ul>
                                    ${value.items.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }

                html += '</div>';
            }

            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('show');

            // ë‹¤ìš´ë¡œë“œ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('downloadSection').style.display = 'block';

            // ìŠ¤í¬ë¡¤
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function toggleCollapse(element) {
            element.classList.toggle('active');
            const content = element.nextElementSibling;

            if (content.style.maxHeight) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
            }
        }

        // ========== í†µí•© í¸ì§‘ ëª¨ë‹¬ ê¸°ëŠ¥ ==========
        let unifiedEdits = {}; // LocalStorageì— ì €ì¥ë  ë°ì´í„°

        // LocalStorageì—ì„œ í¸ì§‘ ë°ì´í„° ë¡œë“œ
        function loadEditsFromStorage() {
            const saved = localStorage.getItem('salesmap_unified_edits');
            if (saved) {
                unifiedEdits = JSON.parse(saved);
            }
        }

        // LocalStorageì— í¸ì§‘ ë°ì´í„° ì €ì¥
        function saveEditsToStorage() {
            localStorage.setItem('salesmap_unified_edits', JSON.stringify(unifiedEdits));
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        loadEditsFromStorage();

        function openUnifiedEditor() {
            if (!currentData || !currentData.similar_groups) {
                alert('ë¨¼ì € ë°ì´í„°ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.');
                return;
            }

            const similarGroups = currentData.similar_groups;
            const modalBody = document.getElementById('unifiedModalBody');
            modalBody.innerHTML = '';

            if (similarGroups.length === 0) {
                modalBody.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">ìœ ì‚¬í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                document.getElementById('unifiedEditModal').classList.add('show');
                return;
            }

            similarGroups.forEach((group, groupIndex) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'edit-item';
                groupDiv.style.marginBottom = '30px';

                let html = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px 8px 0 0; margin: -20px -20px 15px -20px;">
                        <strong style="font-size: 16px;">ê·¸ë£¹ ${groupIndex + 1}</strong>
                        <span style="opacity: 0.9; margin-left: 10px;">${group.items_list.length}ê°œ ìœ ì‚¬ í•­ëª©</span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #667eea;">ëŒ€í‘œ ì´ë¦„ ì„ íƒ:</strong>
                    </div>
                    <div class="edit-options">
                `;

                // ì €ì¥ëœ ê°’ì´ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì˜¤ê¸°
                const savedRep = unifiedEdits[`group_${groupIndex}`]?.representative;
                const savedMerges = unifiedEdits[`group_${groupIndex}`]?.merges || {};

                // ê° í•­ëª©ì„ ë¼ë””ì˜¤ ë²„íŠ¼ìœ¼ë¡œ í‘œì‹œ
                group.items_list.forEach((item, itemIndex) => {
                    const radioId = `unified_rep_${groupIndex}_${itemIndex}`;
                    const isDefault = item.text === group.representative;
                    const isChecked = savedRep ? (savedRep === item.text) : isDefault;
                    const groupsText = item.groups.join(', ');

                    html += `
                        <div class="edit-option" onclick="selectUnifiedOption(this, ${groupIndex})">
                            <input type="radio"
                                   id="${radioId}"
                                   name="unified_rep_${groupIndex}"
                                   value="${item.text}"
                                   ${isChecked ? 'checked' : ''}
                                   onchange="saveUnifiedEdit(${groupIndex})">
                            <label for="${radioId}" style="flex: 1;">
                                <strong>${item.text}</strong>
                                <div style="font-size: 11px; color: #666; margin-top: 4px;">
                                    ì¶œí˜„: ${item.count}ê°œ ì‹œíŠ¸ (${groupsText})
                                </div>
                            </label>
                        </div>
                    `;
                });

                html += `
                    </div>
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                        <strong style="color: #667eea;">ë³‘í•©í•  í•­ëª© ì„ íƒ:</strong>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">ì²´í¬ëœ í•­ëª©ì€ ëŒ€í‘œ ì´ë¦„ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤</div>
                    </div>
                    <div style="margin-top: 10px;">
                `;

                // ë³‘í•© ì²´í¬ë°•ìŠ¤
                group.items_list.forEach((item, itemIndex) => {
                    const checkId = `unified_merge_${groupIndex}_${itemIndex}`;
                    const isChecked = savedMerges[item.text] !== undefined ? savedMerges[item.text] : true;

                    html += `
                        <div style="padding: 8px; margin: 4px 0;">
                            <input type="checkbox"
                                   id="${checkId}"
                                   value="${item.text}"
                                   ${isChecked ? 'checked' : ''}
                                   onchange="saveUnifiedEdit(${groupIndex})"
                                   style="margin-right: 8px;">
                            <label for="${checkId}">${item.text}</label>
                        </div>
                    `;
                });

                html += '</div>';

                groupDiv.innerHTML = html;
                groupDiv.setAttribute('data-group-index', groupIndex);
                groupDiv.setAttribute('data-group-data', JSON.stringify(group));
                modalBody.appendChild(groupDiv);
            });

            document.getElementById('unifiedModalProgress').textContent = `${similarGroups.length}ê°œ ê·¸ë£¹`;
            document.getElementById('unifiedEditModal').classList.add('show');
        }

        function selectUnifiedOption(element, groupIndex) {
            const radio = element.querySelector('input[type="radio"]');
            if (radio) {
                radio.checked = true;
                saveUnifiedEdit(groupIndex);
            }
        }

        function saveUnifiedEdit(groupIndex) {
            // ëŒ€í‘œ ì´ë¦„
            const repRadio = document.querySelector(`input[name="unified_rep_${groupIndex}"]:checked`);
            if (!repRadio) return;

            const representative = repRadio.value;

            // ë³‘í•©í•  í•­ëª©ë“¤
            const mergeCheckboxes = document.querySelectorAll(`input[id^="unified_merge_${groupIndex}_"]`);
            const merges = {};

            mergeCheckboxes.forEach(checkbox => {
                merges[checkbox.value] = checkbox.checked;
            });

            // ì €ì¥
            unifiedEdits[`group_${groupIndex}`] = {
                representative: representative,
                merges: merges
            };

            saveEditsToStorage();
        }

        function closeUnifiedModal() {
            document.getElementById('unifiedEditModal').classList.remove('show');
        }

        function applyUnifiedChanges() {
            if (!currentData || !currentData.similar_groups) return;

            const similarGroups = currentData.similar_groups;
            const numGroups = parseInt(document.getElementById('numGroups').value);

            // ê° ê·¸ë£¹ì˜ ë³€ê²½ì‚¬í•­ ìˆ˜ì§‘
            const allChanges = {}; // groupName -> [{old, new}]

            for (let i = 0; i < numGroups; i++) {
                allChanges[document.getElementById(`groupName${i}`).value] = [];
            }

            similarGroups.forEach((group, groupIndex) => {
                const edit = unifiedEdits[`group_${groupIndex}`];
                if (!edit) return;

                const representative = edit.representative;
                const merges = edit.merges;

                // ë³‘í•©í•  í•­ëª©ë“¤ ì²˜ë¦¬
                group.items_list.forEach(item => {
                    if (merges[item.text] && item.text !== representative) {
                        // ì´ í•­ëª©ì´ ì†í•œ ëª¨ë“  ì‹œíŠ¸ì—ì„œ ë³€ê²½
                        item.groups.forEach(groupName => {
                            allChanges[groupName].push({
                                old: item.text,
                                new: representative
                            });
                        });
                    }
                });
            });

            // ëª¨ë“  ì‹œíŠ¸ì— ë³€ê²½ì‚¬í•­ ì ìš©
            for (let i = 0; i < numGroups; i++) {
                const groupName = document.getElementById(`groupName${i}`).value;
                const changes = allChanges[groupName];

                if (changes && changes.length > 0) {
                    applyChangesToInputByName(groupName, changes);
                }
            }

            closeUnifiedModal();

            // ì¬ë¶„ì„
            setTimeout(() => {
                // í¸ì§‘ ë°ì´í„° ì´ˆê¸°í™”
                unifiedEdits = {};
                saveEditsToStorage();
                analyzeData();
            }, 300);
        }

        function applyChangesToInputByName(groupName, changes) {
            const numGroups = parseInt(document.getElementById('numGroups').value);
            let groupIndex = -1;

            for (let i = 0; i < numGroups; i++) {
                if (document.getElementById(`groupName${i}`).value === groupName) {
                    groupIndex = i;
                    break;
                }
            }

            if (groupIndex === -1) return;

            const textarea = document.getElementById(`groupData${groupIndex}`);
            let lines = textarea.value.split('\n');

            changes.forEach(change => {
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i] === change.old) {
                        lines[i] = change.new;
                    }
                }
            });

            textarea.value = lines.join('\n');
            updateCount(groupIndex);
        }

        // ê¸°ì¡´ openEditModal í•¨ìˆ˜ ì œê±° (ì‚¬ìš© ì•ˆ í•¨)
        function openEditModal(key) {
            currentEditKey = key;
            const [from, to] = key.split('â†’');
            const missingItems = currentData.coverage_matrix[key].missing;

            document.getElementById('modalTitle').textContent = `${from} â†’ ${to} ë§¤í•‘ í¸ì§‘`;

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = '';

            editModalData[key] = {};

            missingItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'edit-item';

                let optionsHTML = `
                    <div class="edit-item-header">${index + 1}. ${item.item}</div>
                    <div class="edit-options">
                `;

                // ìœ ì‚¬ í•­ëª©ë“¤
                if (item.suggestions && item.suggestions.length > 0) {
                    item.suggestions.forEach((suggestion, si) => {
                        const radioId = `radio_${index}_${si}`;
                        const scoreColor = suggestion.score >= 90 ? '#28a745' : suggestion.score >= 80 ? '#ffc107' : '#667eea';
                        optionsHTML += `
                            <div class="edit-option" onclick="selectOption(this)">
                                <input type="radio" id="${radioId}" name="edit_${index}" value="suggestion_${si}" data-text="${suggestion.text}">
                                <label for="${radioId}">${suggestion.text}</label>
                                <span class="similarity-badge" style="background: ${scoreColor}">${suggestion.score}% ìœ ì‚¬</span>
                            </div>
                        `;
                    });
                }

                // ìƒˆë¡œ ì…ë ¥
                const customRadioId = `radio_${index}_custom`;
                optionsHTML += `
                    <div class="edit-option" onclick="selectOption(this)">
                        <input type="radio" id="${customRadioId}" name="edit_${index}" value="custom">
                        <label for="${customRadioId}">ìƒˆë¡œ ì…ë ¥</label>
                    </div>
                    <input type="text" class="custom-input" id="custom_${index}" placeholder="ìƒˆ ì´ë¦„ ì…ë ¥..." style="display: none;">
                `;

                // ë„˜ì–´ê°€ê¸° (í—ˆìš©) - ê¸°ë³¸ ì„ íƒ
                const skipRadioId = `radio_${index}_skip`;
                optionsHTML += `
                    <div class="edit-option" onclick="selectOption(this)">
                        <input type="radio" id="${skipRadioId}" name="edit_${index}" value="skip" checked>
                        <label for="${skipRadioId}">ë„˜ì–´ê°€ê¸° (í˜„ì¬ ìƒíƒœ ìœ ì§€)</label>
                    </div>
                `;

                optionsHTML += '</div>';
                itemDiv.innerHTML = optionsHTML;
                modalBody.appendChild(itemDiv);
            });

            document.getElementById('modalProgress').textContent = `${missingItems.length}ê°œ í•­ëª©`;
            document.getElementById('editModal').classList.add('show');
        }

        function selectOption(optionElement) {
            const radio = optionElement.querySelector('input[type="radio"]');
            radio.checked = true;

            // custom ì„ íƒ ì‹œ input ë³´ì´ê¸°
            const customInput = optionElement.parentElement.querySelector('.custom-input');
            if (customInput) {
                if (radio.value === 'custom') {
                    customInput.style.display = 'block';
                    customInput.focus();
                } else {
                    customInput.style.display = 'none';
                }
            }
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        function skipAllModal() {
            const modalBody = document.getElementById('modalBody');
            const skipRadios = modalBody.querySelectorAll('input[value="skip"]');
            skipRadios.forEach(radio => {
                radio.checked = true;
            });
        }

        function applyChanges() {
            const [from, to] = currentEditKey.split('â†’');
            const missingItems = currentData.coverage_matrix[currentEditKey].missing;
            const changes = [];

            missingItems.forEach((item, index) => {
                const selectedRadio = document.querySelector(`input[name="edit_${index}"]:checked`);

                if (selectedRadio) {
                    if (selectedRadio.value.startsWith('suggestion_')) {
                        // ìœ ì‚¬ í•­ëª© ì„ íƒ
                        const newValue = selectedRadio.getAttribute('data-text');
                        changes.push({ old: item.item, new: newValue });
                    } else if (selectedRadio.value === 'custom') {
                        // ì»¤ìŠ¤í…€ ì…ë ¥
                        const customInput = document.getElementById(`custom_${index}`);
                        const newValue = customInput.value.trim();
                        if (newValue) {
                            changes.push({ old: item.item, new: newValue });
                        }
                    }
                    // skipì¸ ê²½ìš° ë³€ê²½í•˜ì§€ ì•ŠìŒ
                }
            });

            // Input ë°ì´í„°ì— ë³€ê²½ì‚¬í•­ ë°˜ì˜
            if (changes.length > 0) {
                applyChangesToInput(from, changes);

                // ëª¨ë‹¬ ë‹«ê¸°
                closeModal();

                // ì¬ë¶„ì„
                setTimeout(() => {
                    analyzeData();
                }, 300);
            } else {
                closeModal();
            }
        }

        function applyChangesToInput(groupName, changes) {
            // ê·¸ë£¹ ì´ë¦„ìœ¼ë¡œ input ì°¾ê¸°
            const numGroups = parseInt(document.getElementById('numGroups').value);
            let groupIndex = -1;

            for (let i = 0; i < numGroups; i++) {
                const name = document.getElementById(`groupName${i}`).value;
                if (name === groupName) {
                    groupIndex = i;
                    break;
                }
            }

            if (groupIndex === -1) return;

            // í˜„ì¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const textarea = document.getElementById(`groupData${groupIndex}`);
            let lines = textarea.value.split('\n');

            // ë³€ê²½ì‚¬í•­ ì ìš©
            changes.forEach(change => {
                const oldIndex = lines.indexOf(change.old);
                if (oldIndex !== -1) {
                    lines[oldIndex] = change.new;
                }
            });

            // ì—…ë°ì´íŠ¸
            textarea.value = lines.join('\n');
            updateCount(groupIndex);
        }

        function downloadCorrectedData() {
            const numGroups = parseInt(document.getElementById('numGroups').value);
            let tsvContent = '';

            // í—¤ë”
            const headers = [];
            for (let i = 0; i < numGroups; i++) {
                headers.push(document.getElementById(`groupName${i}`).value);
            }
            tsvContent += headers.join('\t') + '\n';

            // ë°ì´í„° (ë¹ˆ í–‰ í¬í•¨, ì›ë³¸ ê·¸ëŒ€ë¡œ)
            const allData = [];
            let maxLength = 0;

            for (let i = 0; i < numGroups; i++) {
                // splitë§Œ í•˜ê³  filter ì œê±° - ë¹ˆ í–‰ë„ ìœ ì§€
                const data = document.getElementById(`groupData${i}`).value.split('\n');
                allData.push(data);
                maxLength = Math.max(maxLength, data.length);
            }

            // í–‰ë³„ë¡œ TSV ìƒì„± (ë¹ˆ í–‰ë„ í¬í•¨)
            for (let row = 0; row < maxLength; row++) {
                const rowData = [];
                for (let col = 0; col < numGroups; col++) {
                    // ë¹ˆ ë¬¸ìì—´ë„ ê·¸ëŒ€ë¡œ ìœ ì§€
                    rowData.push(allData[col][row] !== undefined ? allData[col][row] : '');
                }
                tsvContent += rowData.join('\t') + '\n';
            }

            // ë‹¤ìš´ë¡œë“œ
            const blob = new Blob([tsvContent], { type: 'text/tab-separated-values;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `salesmap_corrected_${new Date().toISOString().slice(0, 10)}.tsv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
